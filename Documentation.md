# Documentation

 - [Important Notes](#important-notes)
 - [Downloading and running the container to convert a BIG-IP configuration](#downloading-and-running-the-container-to-convert-a-BIG-IP-configuration)
 - [Example](#example)


Welcome to the documentation for the F5 AS3 Configuration Converter (ACC).  ACC is used to convert BIG-IP configurations to AS3 declarations. The converter, which runs in a Docker container, uses UCS files, SCF files, or bigip.conf files to output valid AS3 declaration stanzas. You must have Docker installed and running to use this solution.

For answers to frequently asked questions see the [FAQ](FAQ.md).  The [Revision History](revision-history.md) contains information about ACC releases.

## Important notes

  - Currently ACC does not support all BIG-IP configuration object types, although coverage will increase over time.

  - Only TMOS versions 12.1+ are supported.

  - After the conversion, some manipulation of AS3 stanzas may be required.

  - The converter produces an AS3 declaration, placing any configuration objects located in  **/Common** partition on the source BIG-IP into **/Common/Shared** (an existing AS3 construct).

  - For a list of the objects that are converted, see [FAQ](FAQ.md).

  - iApp template configurations are not supported by this tool.

  - iRules only export in UTF-8 (no base64), and comments are removed by the parser.

  - TLS/SSL certificates and keys are only extracted if the input source is a UCS file, and the private keys were included when the UCS was created (default option).
    **Note:** Passphrases/passwords CAN be extracted as a cryptogram and not cleartext, although *the output generated by the converter will only work on the same BIG-IP instance that created the configuration input.*

  - Multiple Client_TLS and Server_TLS profiles have limited support. Configurations will be converted, but to apply them follow the instructions listed [here:](https://clouddocs.f5.com/products/extensions/f5-appsvcs-extension/latest/declarations/tls-encryption.html#referencing-multiple-ssl-profiles-on-a-single-virtual-service)
   **SSL profiles must exist on the BIG-IP device.**

  - All items on the pre-AS3 configuration must be uniquely named. BIG-IP itself allows some objects to have the same name, while AS3 does not.
  **Any object with a duplicate name will be overwritten.**

  - By default, ACC sets *"shareNodes":true* for all nodes. *"shareNodes":true* is appended to the node to avoid conflicts or errors when exporting more than one AS3 configuration sharing the same node, and is set to *true* even if no duplicate nodes are configured.

  For example:

  ```json
  "web_pool1": {
                "class": "Pool",
                "members": [
                    {
                        "serverAddresses": [
                            "10.244.1.58"
                        ],
                        "servicePort": 80,
                        "shareNodes": true
                }
```

## Downloading and running the container to convert a BIG-IP configuration
First, download the Docker container from this repo, and then run the container.  In the following procedure, we are converting a UCS file, so we use the -u flag.

  1. Download the container tar file from the **dist** directory on the Master branch in this [repo:](https://gitswarm.f5net.com/automation-toolchain/as3-charon/-/tree/master/dist)
  2. Load the image using the following command (you many need to update the version of Charon in this command): `docker load -i f5-appsvcs-charon-1.0.0.tar.gz`.
  3. Run the converter by using one of the following commands, replacing the ACC version where necessary):
      - For Linux-based systems and Mac, using the following syntax:
       ``docker run --rm -v  "$PWD":/app/data f5-appsvcs-charon:1.0.0 -o data/<output-file-name>.json -u data/<input-ucs-file-name>.ucs``
       For example:
       ``docker run --rm -v  "$PWD":/app/data f5-appsvcs-charon:1.0.0 -o data/output.json -u data/myucs.ucs``

      - On Windows, use the following syntax:
       ``docker run --rm -v %cd%:/app/data f5-appsvcs-charon:1.0.0 -o data/<output-file-name>.json -u data/<input-ucs-file-name>.ucs``
       For example:
       ``docker run --rm -v  %cd%:/app/data f5-appsvcs-charon:1.0.0 -o data/output.json -u data/myucs.ucs``

       **Note:** The source UCS/SCF file must be located in the CURRENT directory to run the command line from the example. The *data/myucs.ucs* entry refers to a directory inside the container.

       If you are using Windows, and you receive a message such as `Error response from daemon: Drive has not been shared.`, `Error loading conf/SCF file, please check the filepath.`, or `Error extracting specified UCS, please check the file path.` you may need to share the drive or update your shared drive credentials.  Go to the Docker Desktop application and click the **Shared Drives** tab.  Verify the drive you are executing the command on is shared.  Whenever your Windows password changes, you need to click `Reset credentials`, reselect the shared drive, click `Apply`, and then re-enter your credentials.  Additionally, the Windows commands are for the Windows Command prompt (cmd) and do NOT work on Powershell.



Docker command line options:

  - The **docker run** portion of the command starts the container.

  - The **--rm** option removes the container after it exits from running the application.  Without this the container will persist after it exits and you may have to run a command such as `docker container prune` to remove leftover containers.

  -  The application is located in the **/app** directory of the container.

  - The **-v** option maps the current directory to the **/app/data** directory in the container.  This is used to read input and write output with the container.  In this example we assume the input UCS file and the output JSON file will be read from and written to the current directory.

ACC command line options:

  - The **-o** option specifies the output file name.  You must specify this as being in the **data** directory (with the Docker **-v** option).  When the output file is written in the container it is written to the **/app/data** directory of the container which maps back to the current directory outside of the container where output.json will actually be written.

  - The **-u** option specifies a UCS file for the application to read.  For either .conf or SCF files, use the **-c** flag. This must be specified as being in the *data* directory (as specified with the **-v** option).  When the input file is read by the application, it is read from the **/app/data** directory of the container which maps back to the current directory outside of the container where input file is actually read.  This flag is required and you must use only one option of **-u** or **-c**, depending on your input file.

  - The **--recognized** option logs to **stdout** a list of configuration objects that ACC recognized.

  - The **--recognized-objects** option logs to specified file of objects (JSON format) that were recognized.

  - The **--supported** option logs to **stdout** a list of configuration objects that ACC will convert.

  - The **--supported-objects** option logs to specified file of objects (JSON format) that were converted.

  - The **--unsupported** option logs to **stdout** a list of configuration objects that ACC did not convert. **Note:** Objects that will never receive AS3 support are filtered out of this list.

  - The **--unsupported-objects** option logs to specified file of objects (JSON format) that were not converted. **Note:** Objects that will never receive AS3 support are filtered out of this list.

  - The **--summary** option logs to **stdout** counts of each generated class.

  - The **--disable-analytics** option will disable usage reporting. All data is anonymized, and this option is enabled by default.

  - The **--controls** option will add debugging "Controls" stanza to declaration.

  - The **--safety-net** option allows a user to bypass fatal conversion errors and generate a best-effort declaration. Accepts a boolean parameter, and defaults to **true**.

  - The **-v** option will filter output by the virtual server name specified. Only this virtual server and dependent objects will be posted to the resulting file.

  - The **-a** option puts virtual server to specific application. Works only if the **-v** option is specified. The original VS application is used if this option not specified.

  - The **-t** option puts virtual server to specific tenant. Works only if **-v**  option specified. The original VS tenant is used if this option not specified.



## Testing the results
The best way to test the results is to take the output file and POST that AS3 declaration to a BIG-IP. If the declaration fails, look closely at the error messages, which should provide information on the part of the declaration  needing attention.

If you attempt to run ACC, and it provides an unexpected error message, it is likely an issue with the parser, and the development team wants to hear about it.  Email \*solutionsfeedback@f5.com with as much information about what you were attempting as possible.


### Example

In this section we show a simple BIG-IP configuration from a UCS file, the command to convert and the response from the container, and finally the resulting AS3 declaration output.

The following is the relevant portion of our example UCS file named **charon.ucs**.

```bash
#TMSH-VERSION: 13.1.0.8

ltm pool /Common/testCharonPool {
    monitor /Common/testCharonMonitor
}
ltm virtual /Common/testCharonVip {
    destination /Common/192.0.2.14:80
    ip-protocol tcp
    mask 255.255.255.255
    pool /Common/testCharonPool
    profiles {
        /Common/tcp { }
        /Common/testCharonHTTP { }
    }
    source 0.0.0.0/0
    translate-address enabled
    translate-port enabled
}
ltm virtual-address /Common/192.0.2.14 {
    address 192.0.2.14
    arp enabled
    mask 255.255.255.255
    traffic-group /Common/traffic-group-1
}

ltm monitor http /Common/testCharonMonitor {
    adaptive disabled
    defaults-from /Common/http
    destination *:*
    interval 30
    ip-dscp 0
    recv none
    recv-disable none
    send "GET /\r\n"
    time-until-up 0
    timeout 91
}
ltm profile http /Common/testCharonHTTP {
    app-service none
    defaults-from /Common/http
    proxy-type reverse
    redirect-rewrite matching
}

```

This UCS file is put in the same directory from which we are running the container.  In the following example, we are running the container from a Windows machine:

```
C:\Users\jordan\Desktop\charon\dist>docker run --rm -v %cd%:/app/data f5-appsvcs-charon:1.0.0 -o data/output.json -u data/charon.ucs --summary
1118 configuration objects detected
31 objects are recognized by AS3
12 objects are supported by Charon
Generated Declaration { Pool: 1,
  Monitor: 1,
  HTTP_Profile: 1 }
```

Once it has run through the converter, the resulting AS3 declaration looks like this:

```json
{
    "class": "ADC",
    "schemaVersion": "3.8.0",
    "id": "urn:uuid:8c029a82-2db6-49ba-8108-959894612b32",
    "label": "Converted Declaration",
    "remark": "Auto-generated by Project Charon",
    "Common": {
        "class": "Tenant",
        "Shared": {
            "class": "Application",
            "template": "shared",
            "testCharonPool": {
                "monitors": [
                    {
                        "use": "/Common/Shared/testCharonMonitor"
                    }
                ],
                "class": "Pool"
            },
            "testCharonVip": {
                "layer4": "tcp",
                "pool": "testCharonPool",
                "source": "0.0.0.0/0",
                "translateServerAddress": true,
                "translateServerPort": true,
                "class": "Service_Generic",
                "profileHTTP": {
                    "use": "/Common/Shared/testCharonHTTP"
                },
                "virtualAddresses": [
                    "192.0.2.14"
               ],
                "virtualPort": 80
            },
            "testCharonMonitor": {
                "adaptive": false,
                "interval": 30,
                "dscp": 0,
                "receive": "none",
                "send": "GET /\\r\\n",
                "timeUntilUp": 0,
                "timeout": 91,
                "class": "Monitor",
                "monitorType": "http"
            },
            "testCharonHTTP": {
                "proxyType": "reverse",
                "rewriteRedirects": "matching",
                "class": "HTTP_Profile"
            }
        }
    }
}
```


### Example by Application

In this section, we show a simple BIG-IP configuration from a UCS file, the command to convert, extract a **single virtual server** and the response from the container, and then the resulting AS3 declaration output.

The following is the relevant portion of our example UCS file named **charon.ucs**, the virtual we extract is named **f5-big-ip** and we place it into a tenant named **Ten** and an application **Appl**. If the tenant is not specified, ACC uses original tenant name; if the application is not specified, the AS3 application uses the virtual name.

```bash
#TMSH-VERSION: 13.1.0.8

ltm pool /Common/testCharonPool {
    monitor /Common/testCharonMonitor
}
ltm virtual /Common/testCharonVip {
    destination /Common/192.0.2.14:80
    ip-protocol tcp
    mask 255.255.255.255
    pool /Common/testCharonPool
    profiles {
        /Common/tcp { }
        /Common/testCharonHTTP { }
    }
    source 0.0.0.0/0
    translate-address enabled
    translate-port enabled
}
ltm virtual-address /Common/192.0.2.14 {
    address 192.0.2.14
    arp enabled
    mask 255.255.255.255
    traffic-group /Common/traffic-group-1
}

ltm monitor http /Common/testCharonMonitor {
    adaptive disabled
    defaults-from /Common/http
    destination *:*
    interval 30
    ip-dscp 0
    recv none
    recv-disable none
    send "GET /\r\n"
    time-until-up 0
    timeout 91
}
ltm profile http /Common/testCharonHTTP {
    app-service none
    defaults-from /Common/http
    proxy-type reverse
    redirect-rewrite matching
}
ltm virtual /Custom/testCharonVip {
    destination /Common/192.0.2.14:80
    ip-protocol tcp
    mask 255.255.255.255
    pool /Common/testCharonPool
    profiles {
        /Common/tcp { }
        /Common/testCharonHTTP { }
    }
    source 0.0.0.0/0
    translate-address enabled
    translate-port enabled
}
ltm virtual-address /Custom/192.0.2.14 {
    address 192.0.2.14
    arp enabled
    mask 255.255.255.255
    traffic-group /Common/traffic-group-1
}

ltm monitor http /Custom/testCharonMonitor {
    adaptive disabled
    defaults-from /Common/http
    destination *:*
    interval 30
    ip-dscp 0
    recv none
    recv-disable none
    send "GET /\r\n"
    time-until-up 0
    timeout 91
}
ltm profile http /Common/testCharonHTTP {
    app-service none
    defaults-from /Common/http
    proxy-type reverse
    redirect-rewrite matching
}

```

This UCS file is put in the same directory from which we are running the container.  In the following example, we are running the container from a Windows machine:

```
C:\Users\jordan\Desktop\charon\dist>docker run --rm -v %cd%:/app/data f5-appsvcs-charon:1.2.0 -o data/output.json -u data/charon.ucs  -v /Custom/testCharonVip -a Appl -t Ten --summary
8 BIG-IP objects detected total
6 BIG-IP objects recognized by AS3
8 BIG-IP objects supported by Charon
3 AS3 stanzas generated
{ Monitor: 1, Pool: 1, Service_HTTP: 1 }
```

Once it has run through the converter, the resulting AS3 declaration looks like this:

```json
{
    "class": "ADC",
    "schemaVersion": "3.11.0",
    "id": "urn:uuid:6ebb5310-dcc6-42ba-83ab-3f9524827bae",
    "label": "Converted Declaration",
    "remark": "Auto-generated by Project Charon",
    "Ten": {
        "class": "Tenant",
        "Appl": {
            "class": "Application",
            "template": "http",
            "serviceMain": {
                "layer4": "tcp",
                "pool": "testCharonPool",
                "translateServerAddress": true,
                "translateServerPort": true,
                "class": "Service_HTTP",
                "profileTCP": {
                    "bigip": "/Common/tcp"
                },
                "profileHTTP": {
                    "use": "/Common/Shared/testCharonHTTP"
                },
                "virtualAddresses": [
                    "192.0.2.14"
                ],
                "virtualPort": 80,
                "snat": "none",
                "remark": "testCharonVip"
            },
            "testCharonPool": {
                "monitors": [
                    {
                        "use": "/Ten/Appl/testCharonMonitor"
                    }
                ],
                "class": "Pool"
            },
            "testCharonMonitor": {
                "adaptive": false,
                "interval": 30,
                "dscp": 0,
                "receive": "none",
                "send": "GET /\\r\\n",
                "timeUntilUp": 0,
                "timeout": 91,
                "class": "Monitor",
                "monitorType": "http",
                "targetAddress": "",
                "targetPort": 0
            }
        }
    }
}
```
