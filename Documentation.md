# Documentation

 - [Important Notes](#important-notes)
 - [Downloading and running the container to convert a BIG-IP configuration](#downloading-and-running-the-container-to-convert-a-BIG-IP-configuration)
 - [Example](#example)


Welcome to the documentation for the F5 AS3 Configuration Converter (ACC).  ACC is used to convert BIG-IP configurations to AS3 declarations. The converter, which runs in a Docker container, uses UCS files, SCF files, or bigip.conf files to output valid AS3 declaration stanzas. You must have Docker installed and running to use this solution.

For answers to frequently asked questions see the [FAQ](FAQ.md).

## Important notes

  - Currently ACC does not support all BIG-IP configuration object types, although coverage will increase over time.

  - Only TMOS versions 12.1+ are supported.

  - After the conversion, some manipulation of AS3 stanzas may be required.

  - The converter produces an AS3 declaration, placing any configuration objects located in  **/Common** partition on the source BIG-IP into **/Common/Shared** (an existing AS3 construct).

  - For a list of the objects that are converted, see [FAQ](FAQ.md).

  - While ACC will convert a BIG-IP app services configuration created by a legacy iApp template, ACC will ignore the iApp template configuration itself.

  - iRules only export in UTF-8 (no base64), and comments are removed by the parser.

  - TLS/SSL certificates and keys are only extracted if the input source is a UCS file, and the private keys were included when the UCS was created (default option).
    **Note:** Passphrases/passwords CAN be extracted as a cryptogram and not cleartext, although *the output generated by the converter will only work on the same BIG-IP instance that created the configuration input.*

  - Multiple Client_TLS and Server_TLS profiles have limited support. Configurations will be converted, but to apply them follow the instructions listed [here:](https://clouddocs.f5.com/products/extensions/f5-appsvcs-extension/latest/declarations/tls-encryption.html#referencing-multiple-ssl-profiles-on-a-single-virtual-service)
   **SSL profiles must exist on the BIG-IP device.**

  - All items on the pre-AS3 configuration must be uniquely named. BIG-IP itself allows some objects to have the same name, while AS3 does not.
  **Any object with a duplicate name will be overwritten.**

  - By default, ACC sets *"shareNodes":true* for all nodes. *"shareNodes":true* is appended to the node to avoid conflicts or errors when exporting more than one AS3 configuration sharing the same node, and is set to *true* even if no duplicate nodes are configured.

  For example:

  ```json
  "web_pool1": {
                "class": "Pool",
                "members": [
                    {
                        "serverAddresses": [
                            "10.244.1.58"
                        ],
                        "servicePort": 80,
                        "shareNodes": true
                }
```

## Installing ACC and running a conversion
**Note:**  Before you begin, you must have Docker installed and running. It can be found on the  [GitHub repo](https://github.com/f5devcentral/f5-as3-config-converter/releases/) in the **Assets** section on the **Releases** tab

 1. Download the tar file from the **Assets** section on the **Releases** tab of the [GitHub repo](https://github.com/f5devcentral/f5-as3-config-converter/releases/)
 2. Load the image using the following command, replacing x.x.x with the version of ACC you are installing: `docker load -i f5-as3-config-converter-x.x.x.tar.gz`.

  In the following procedure, we are converting a UCS file, so we use the -u flag.

 3. Run the converter by using one of the following commands, replacing the ACC version where necessary:
     - For Linux-based systems and Mac, using the following syntax:
       ``docker run --rm -v  "$PWD":/app/data f5-as3-config-converter:x.x.x -o data/<output-file-name>.json -u data/<input-ucs-file-name>.ucs``
       For example:
       ``docker run --rm -v  "$PWD":/app/data f5-as3-config-converter:x.x.x -o data/output.json -u data/myucs.ucs``

     - On Windows, use the following syntax:
       ``docker run --rm -v %cd%:/app/data f5-as3-config-converter:x.x.x -o data/<output-file-name>.json -u data/<input-ucs-file-name>.ucs``
       For example:
       ``docker run --rm -v  %cd%:/app/data f5-as3-config-converter:x.x.x -o data/output.json -u data/myucs.ucs``

       **Note:** The source UCS/SCF file must be located in the CURRENT directory to run the command line from the example. The *data/myucs.ucs* entry refers to a directory inside the container.

       If you are using Windows, and you receive a message such as `Error response from daemon: Drive has not been shared.`, `Error loading conf/SCF file, please check the filepath.`, or `Error extracting specified UCS, please check the file path.` you may need to share the drive or update your shared drive credentials.  Go to the Docker Desktop application and click the **Shared Drives** tab.  Verify the drive you are executing the command on is shared.  Whenever your Windows password changes, you need to click `Reset credentials`, reselect the shared drive, click `Apply`, and re-enter your credentials.  Additionally, the Windows commands are for the Windows Command prompt (cmd) and do NOT work on Powershell.

 4. Or run ACC as REST-API service
     - Service runs on port 8080 inside the container, or you can map it to any port on your local OS.

       For example:
        ``docker run --rm -v "$PWD":/app/data -p 8080:8080 f5-as3-config-converter:1.0.0  serve``

       Call it with:
        ``curl localhost:8080/as3converter -X POST  --form "ucs=@<input-ucs-file-name>.ucs" --form "output=<output-file-name>.json" --form "verbose=true" |jq .`` 

Using Postman to post to ACC endpoint:

![](\images\ACC-POST1.png)

Input is bigip confguration called **toConvert.conf**.  Output is file **as3Output.json**.

After post:

![](\images\ACC-POST2.png)
        ``curl localhost:8080/as3converter -X POST --form "ucs=@<input-ucs-file-name>.ucs" --form "output=<output-file-name>.json" --form "verbose=true" |jq .``
        Any client similar to Postman can also be used.

### Docker command line options:

  - The **docker run** portion of the command starts the container.

  - The **--rm** option removes the container after it exits from running the application.  Without this the container will persist after it exits and you may have to run a command such as `docker container prune` to remove leftover containers.

  -  The application is located in the **/app** directory of the container.

  - The **-v** option maps the current directory to the **/app/data** directory in the container.  This is used to read input and write output with the container.  In this example we assume the input UCS file and the output JSON file will be read from and written to the current directory.

  - The **-p** option maps the tcp port inside container to the local OS port.

### ACC command line options:

  - The **-o** option specifies the output file name.  You must specify this as being in the **data** directory (with the Docker **-v** option).  When the output file is written in the container it is written to the **/app/data** directory of the container which maps back to the current directory outside of the container where output.json will actually be written.

  - The **-u** option specifies a UCS file for the application to read.  For either .conf or SCF files, use the **-c** flag. This must be specified as being in the *data* directory (as specified with the **-v** option).  When the input file is read by the application, it is read from the **/app/data** directory of the container which maps back to the current directory outside of the container where input file is actually read.  This flag is required and you must use only one option of **-u** or **-c**, depending on your input file.

  - The **--recognized** option logs to **stdout** a list of configuration objects that ACC recognized.

  - The **--recognized-objects** option logs to specified file of objects (JSON format) that were recognized.

  - The **--supported** option logs to **stdout** a list of configuration objects that ACC will convert.

  - The **--supported-objects** option logs to specified file of objects (JSON format) that were converted.

  - The **--unsupported** option logs to **stdout** a list of configuration objects that ACC did not convert. **Note:** Objects that will never receive AS3 support are filtered out of this list.

  - The **--unsupported-objects** option logs to specified file of objects (JSON format) that were not converted. **Note:** Objects that will never receive AS3 support are filtered out of this list.

  - The **--summary** option logs to **stdout** counts of each generated class.

  - The **--disable-analytics** option will disable usage reporting. All data is anonymized, and this option is enabled by default.

  - The **--controls** option will add debugging "Controls" stanza to declaration.

  - The **--safety-net** option allows a user to bypass fatal conversion errors and generate a best-effort declaration. Accepts a boolean parameter, and defaults to **true**.

  - The **-v** option will filter output by the virtual server name specified. Only this virtual server and dependent objects will be posted to the resulting file.

  - The **-a** option puts the virtual server to specific application. Works only if the **-v** option is specified. The original VS application is used if this option not specified.

  - The **-t** option puts the virtual server to specific tenant. Works only if **-v**  option specified. The original VS tenant is used if this option not specified.

  - REST-API usage related options when the container is started with **serve** option.  **--verbose** prints more details in the REST-API response.

**Note:** The 3 options of **-v**, **-a** and **-t** typically work together with **-a** and **-t** having the ability to work independently. If **-v** is used, then all other virtual servers are ignored. If **-t** is used, then the virtual server will be placed into this tenant name, even if it was originally in /Common/. If **-a** is used, then the original virtual server will be placed under the application name specified. By default the virtual server name will be used as the application.

Examples

```
Original VS    /Common/VS1 

    1) only -a /Common/VS1 provided:   
	"Common": {
	    "class": "tenant",
	    "VS1": {
	            "class": "application"
	             "VS1": {
	             .........................
	              { 
	2) -t My_tenant  in addition to -v 
	"My_tenant": {
	    "class": "tenant",
	    "VS1": {
	            "class": "application"
	             "VS1": {
	             .........................
	              {
	3) -a "My_application"
	"My_tenant": {
	    "class": "tenant",
	    "My_aplication": {
	            "class": "application"
	             "VS1": {
	             .........................
	              {
```


## Testing the results
The best way to test the results is to take the output file and POST the AS3 declaration to a BIG-IP. If the declaration fails, look closely at the error messages, which should provide information on the part of the declaration  needing attention.

If you attempt to run ACC, and it provides an unexpected error message, it is likely an issue with the parser and the development team wants to hear about it. Navigate to the [ACC GitHub page](https://github.com/f5devcentral/f5-as3-config-converter/issues), click **New Issue**.
Select the Issue type of Bug report, click **Get started**.
Give the submission a title then fill out the template, attaching files if applicable.
When finished, click **Submit new issue**.

### Example

In this section we show a simple BIG-IP configuration from a UCS file, the command to convert and the response from the container, and finally the resulting AS3 declaration output.

The following is the relevant portion of our example UCS file named **acc.ucs**.

```bash
#TMSH-VERSION: 13.1.0.8

ltm pool /Common/testaccPool {
    monitor /Common/testaccMonitor
}
ltm virtual /Common/testaccVip {
    destination /Common/192.0.2.14:80
    ip-protocol tcp
    mask 255.255.255.255
    pool /Common/testaccPool
    profiles {
        /Common/tcp { }
        /Common/testaccHTTP { }
    }
    source 0.0.0.0/0
    translate-address enabled
    translate-port enabled
}
ltm virtual-address /Common/192.0.2.14 {
    address 192.0.2.14
    arp enabled
    mask 255.255.255.255
    traffic-group /Common/traffic-group-1
}

ltm monitor http /Common/testaccMonitor {
    adaptive disabled
    defaults-from /Common/http
    destination *:*
    interval 30
    ip-dscp 0
    recv none
    recv-disable none
    send "GET /\r\n"
    time-until-up 0
    timeout 91
}
ltm profile http /Common/testaccHTTP {
    app-service none
    defaults-from /Common/http
    proxy-type reverse
    redirect-rewrite matching
}

```

This UCS file is put in the same directory from which we are running the container.  In the following example, we are running the container from a Windows machine:

```
C:\Users\jordan\Desktop\acc\dist>docker run --rm -v %cd%:/app/data f5-as3-config-converter:1.0.0 -o data/output.json -u data/acc.ucs --summary
1118 configuration objects detected
31 objects are recognized by AS3
12 objects are supported by acc
Generated Declaration { Pool: 1,
  Monitor: 1,
  HTTP_Profile: 1 }
```

Once it has run through the converter, the resulting AS3 declaration looks like this:

```json
{
    "class": "ADC",
    "schemaVersion": "3.8.0",
    "id": "urn:uuid:8c029a82-2db6-49ba-8108-959894612b32",
    "label": "Converted Declaration",
    "remark": "Auto-generated by Project acc",
    "Common": {
        "class": "Tenant",
        "Shared": {
            "class": "Application",
            "template": "shared",
            "testaccPool": {
                "monitors": [
                    {
                        "use": "/Common/Shared/testaccMonitor"
                    }
                ],
                "class": "Pool"
            },
            "testaccVip": {
                "layer4": "tcp",
                "pool": "testaccPool",
                "source": "0.0.0.0/0",
                "translateServerAddress": true,
                "translateServerPort": true,
                "class": "Service_Generic",
                "profileHTTP": {
                    "use": "/Common/Shared/testaccHTTP"
                },
                "virtualAddresses": [
                    "192.0.2.14"
               ],
                "virtualPort": 80
            },
            "testaccMonitor": {
                "adaptive": false,
                "interval": 30,
                "dscp": 0,
                "receive": "none",
                "send": "GET /\\r\\n",
                "timeUntilUp": 0,
                "timeout": 91,
                "class": "Monitor",
                "monitorType": "http"
            },
            "testaccHTTP": {
                "proxyType": "reverse",
                "rewriteRedirects": "matching",
                "class": "HTTP_Profile"
            }
        }
    }
}
```


### Example by Application

In this section, we show a simple BIG-IP configuration from a UCS file, the command to convert and extract a **single virtual server**, the response from the container and then the resulting AS3 declaration output.

The following is the relevant portion of our example UCS file named **acc.ucs**, the virtual we extract is named **f5-big-ip** and we place it into a tenant named **Ten** and an application **Appl**. If the tenant is not specified, ACC uses the original tenant name; if the application is not specified, the AS3 application uses the virtual name.

```bash
#TMSH-VERSION: 13.1.0.8

ltm pool /Common/testaccPool {
    monitor /Common/testaccMonitor
}
ltm virtual /Common/testaccVip {
    destination /Common/192.0.2.14:80
    ip-protocol tcp
    mask 255.255.255.255
    pool /Common/testaccPool
    profiles {
        /Common/tcp { }
        /Common/testaccHTTP { }
    }
    source 0.0.0.0/0
    translate-address enabled
    translate-port enabled
}
ltm virtual-address /Common/192.0.2.14 {
    address 192.0.2.14
    arp enabled
    mask 255.255.255.255
    traffic-group /Common/traffic-group-1
}

ltm monitor http /Common/testaccMonitor {
    adaptive disabled
    defaults-from /Common/http
    destination *:*
    interval 30
    ip-dscp 0
    recv none
    recv-disable none
    send "GET /\r\n"
    time-until-up 0
    timeout 91
}
ltm profile http /Common/testaccHTTP {
    app-service none
    defaults-from /Common/http
    proxy-type reverse
    redirect-rewrite matching
}
ltm virtual /Custom/testaccVip {
    destination /Common/192.0.2.14:80
    ip-protocol tcp
    mask 255.255.255.255
    pool /Common/testaccPool
    profiles {
        /Common/tcp { }
        /Common/testaccHTTP { }
    }
    source 0.0.0.0/0
    translate-address enabled
    translate-port enabled
}
ltm virtual-address /Custom/192.0.2.14 {
    address 192.0.2.14
    arp enabled
    mask 255.255.255.255
    traffic-group /Common/traffic-group-1
}

ltm monitor http /Custom/testaccMonitor {
    adaptive disabled
    defaults-from /Common/http
    destination *:*
    interval 30
    ip-dscp 0
    recv none
    recv-disable none
    send "GET /\r\n"
    time-until-up 0
    timeout 91
}
ltm profile http /Common/testaccHTTP {
    app-service none
    defaults-from /Common/http
    proxy-type reverse
    redirect-rewrite matching
}

```

This UCS file is put in the same directory from which we are running the container, which in the following example, is running on a Windows machine:

For more information on command line usage, see the *ACC command line options:* section above.

```
C:\Users\jordan\Desktop\acc\dist>docker run --rm -v %cd%:/app/data f5-as3-config-converter:1.2.0 -o data/output.json -u data/acc.ucs  -v /Custom/testaccVip -a Appl -t Ten --summary
8 BIG-IP objects detected total
6 BIG-IP objects recognized by AS3
8 BIG-IP objects supported by acc
3 AS3 stanzas generated
{ Monitor: 1, Pool: 1, Service_HTTP: 1 }
```

Once it has run through the converter, the resulting AS3 declaration looks like this:

```json
{
    "class": "ADC",
    "schemaVersion": "3.11.0",
    "id": "urn:uuid:6ebb5310-dcc6-42ba-83ab-3f9524827bae",
    "label": "Converted Declaration",
    "remark": "Auto-generated by Project acc",
    "Ten": {
        "class": "Tenant",
        "Appl": {
            "class": "Application",
            "template": "http",
            "serviceMain": {
                "layer4": "tcp",
                "pool": "testaccPool",
                "translateServerAddress": true,
                "translateServerPort": true,
                "class": "Service_HTTP",
                "profileTCP": {
                    "bigip": "/Common/tcp"
                },
                "profileHTTP": {
                    "use": "/Common/Shared/testaccHTTP"
                },
                "virtualAddresses": [
                    "192.0.2.14"
                ],
                "virtualPort": 80,
                "snat": "none",
                "remark": "testaccVip"
            },
            "testaccPool": {
                "monitors": [
                    {
                        "use": "/Ten/Appl/testaccMonitor"
                    }
                ],
                "class": "Pool"
            },
            "testaccMonitor": {
                "adaptive": false,
                "interval": 30,
                "dscp": 0,
                "receive": "none",
                "send": "GET /\\r\\n",
                "timeUntilUp": 0,
                "timeout": 91,
                "class": "Monitor",
                "monitorType": "http",
                "targetAddress": "",
                "targetPort": 0
            }
        }
    }
}
```

### **Important**

Once a conversion has been completed, all files containing sensitive information such as *certificates*, *keys*, and *passwords*, to name a few, should be deleted or moved to a more secure location. Leaving files of these types unsecured can result in exposure and malicious use of the sensitive data.
